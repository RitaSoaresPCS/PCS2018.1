<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" href="Assets/CSS/geral.css">

    <script src="AcessoDados/Base.js"></script>
    <!-- Carregar apenas se necessário na página: -->
    <script src="AcessoDados/Discussao.js"></script>
    <script src="AcessoDados/Comunidade.js"></script>
    <script src="AcessoDados/Usuario.js"></script>

	
	<script type= 'text/javascript'>
      $(document).ready(function(){
        $('#btn-addDisc').click(function(){
          var titulo= $('#titulo-add').val();
		  var descricao= $('#descricao-add').val();
		  var publica= $('#publica-add').val();
		  var comunidadeAtual = Base.getUrlParameter("id");
		  var userId = localStorage.userId;
          
		  Discussao.adicionar(comunidadeAtual, titulo, descricao, publica, userId, function(data) {
			if (data.erro == true) {
                alert(data.mensagem);
              } else {
                alert("Adicionada com sucesso.");
                location.reload();
              }
		  });
        });
      });
    </script>
	
	
    <script type= 'text/javascript'>
      $(document).ready(function(){
        $('#btn-addParc').click(function(){
          var username= $('#username').val();
		  var comunidadeAtual = Base.getUrlParameter("id");
          if (username!= null)
          {
            $.ajax({
              type: 'POST',
              url: 'ControleDados/UsuarioParceriaComunidade.php',
              contentType: 'application/x-www-form-urlencoded',
              dataType: 'json',
              data: 'func=adicionar&username='+username+'&idComunidade='+comunidadeAtual,
              success: function () {
                alert('Solicitação Enviada');
              }
            });
          }
        });
      });
    </script>
    <script type= 'text/javascript'>
		$(document).ready(function(){
			$('#btn-remover').click(function(){

			  var username = $('#select-remove-parc').val();
			  var comunidadeAtual = Base.getUrlParameter("id");

			  if (username != null)
			  {
				$.ajax({
				  type: 'POST',
				  url: 'ControleDados/UsuarioParceriaComunidade.php',
				  contentType: 'application/x-www-form-urlencoded',
				  dataType: 'json',
				  data: 'func=remover&username='+username+'&idComunidade='+comunidadeAtual,
				  success: function () {
					alert('Parceiro Removido');
				  }
				});
			  }
			});
		});
    </script>

	<script type= 'text/javascript'>
		// Preenche os dados do laboratório.
		$(document).ready(function(){
			Comunidade.getById(Base.getUrlParameter("id"), function(data) {
				data = JSON.parse(data);
				conteudo = "";

				var nome = data.nome;
				var descricao = data.descricao;
				var tema = data.tema;
				Usuario.getById(data.idUsuarioAdministrador, function(dataUs) {
					var usuarioAdmin = JSON.parse(dataUs).username;

					conteudo += "<form>"
					conteudo += "<input type='hidden' name='id' id='id' value='" + data.id + "'>";
					conteudo += "Nome:<br><input type='text' name='nome' id='nome' value='" + nome + "' width='100'><br>";
					conteudo += "Descrição:<br><input type='text' name='descricao' id='descricao' value='" + descricao + "' width='100'><br>";
					conteudo += "Tema:<br><input type='text' name='tema' id='tema' value='" + tema + "' width='100'><br>";
					conteudo += "Administrador:<br><input type='text' name='usuarioAdmin' id='usuarioAdmin' value='" + usuarioAdmin + "' width='100'><br><br>";
					conteudo += "<button id= 'btn-editar-lab' type= 'button'>Editar</button><br>";
					conteudo += "</form>"


					document.getElementById("conteudo").innerHTML = conteudo;


					$('#btn-editar-lab').click(function(){
						var id = $('#id').val();
						var nome = $('#nome').val();
						var descricao = $('#descricao').val();
						var tema = $('#tema').val();
						var userAdmin = $('#usuarioAdmin').val();

						Comunidade.editar(id, nome, descricao, tema, userAdmin, function(resposta) {
							if (resposta.erro == false) {
								window.location.assign('laboratorio.html?id=' + id);
							}
						});
					});
				});
			});

		});
	</script>
  <script type= 'text/javascript'>
  $(document).ready(function(){
    $('body').on('click', 'button[id^="btn-fixar-"]', function(){
      var idDiscussao= this.id.substr(this.id.lastIndexOf('-')+1, this.id.length);
      Discussao.mudarFixo(idDiscussao, 1, function(result){
        if (result.erro== true)
        {
          alert(result.mensagem);
        }else{
          alert('Discussao fixada.');
		  location.reload();
        }
      });
    });
	
	
    $('body').on('click', 'button[id^="btn-desativarDisc-"]', function(){
      var idDiscussao= this.id.substr(this.id.lastIndexOf('-')+1, this.id.length);
      Discussao.remover(idDiscussao, function(result){
        if (result.erro== true)
        {
          alert(result.mensagem);
        }else{
          alert('Discussao removida.');
		  location.reload();
        }
      });
    });
	
	

    $('body').on('click', 'button[id^="btn-desfixar-"]', function(){
      var idDiscussao= this.id.substr(this.id.lastIndexOf('-')+1, this.id.length);
      Discussao.mudarFixo(idDiscussao, 0, function(result){
        if (result.erro== true)
        {
          alert(result.mensagem);
        }else{
          alert('Discussao desfixada.');
		  location.reload();
        }
      });
    });

    Discussao.getDiscussaoDoLab(Base.getUrlParameter("id"), function(discussoes){
      if (discussoes.erro== true)
      {
        alert(data.mensagem);
      }else{
        discussoesSize= discussoes.length;
        for(var iterador= 0; iterador< discussoesSize; iterador++)
        {
          currentDiscuss= discussoes[iterador];
          var dId= currentDiscuss['id'];
          var dIdCreator= currentDiscuss['idCreator'];
          var dTtl= currentDiscuss['ttl'];
          var dCrDate= currentDiscuss['crDate'];
          var dDescriptn= currentDiscuss['descriptn'];
          var dActive= currentDiscuss['active'];
          var dFix= currentDiscuss['fix'];
          var dLastEdit= currentDiscuss['lastEdit'];
          var dPublic= currentDiscuss['public'];

          var divDiscussaoInfo= $('<div />').appendTo('#discussoes');
          var divDiscussaoOuter= $('<div />').appendTo(divDiscussaoInfo);
          var divDiscusssaoInner= $('<div />').appendTo(divDiscussaoInfo);
          var divDiscussaoHeader= $('<div />').appendTo(divDiscussaoOuter);
          var divDiscussaoActions= $('<div />').appendTo(divDiscussaoOuter);
		  
		  
          $('<p />')
            .text(dTtl)
            .appendTo(divDiscussaoHeader);
          $('<br>').appendTo(divDiscussaoHeader);
          $('<p />')
            .text('criada por '+ dIdCreator)//futuramente virará o nome da pessoa.
            .appendTo(divDiscussaoHeader);
          $('<br>').appendTo(divDiscussaoHeader);
		  
		  $('<button />')
              .attr('type', 'button')
              .attr('id', 'btn-desativarDisc-'+dId)
              .text('remover')
              .appendTo(divDiscussaoActions);
			  
			  
			$('<button />')
              .attr('type', 'button')
              .attr('id', 'btn-editarDisc-'+dId)
              .text('editar')
              .appendTo(divDiscussaoActions);
		  
          if (dFix== '0')
          {
            $('<button />')
              .attr('type', 'button')
              .attr('id', 'btn-fixar-'+dId)
              .text('fixar')
              .appendTo(divDiscussaoActions);
          }else{
            $('<button />')
              .attr('type', 'button')
              .attr('id', 'btn-desfixar-'+dId)
              .text('desfixar')
              .appendTo(divDiscussaoActions);
          }
          $('<button />')
            .attr('type', 'button')
            .attr('id', 'btn-responder')
            .text('responder')
            .appendTo(divDiscussaoActions);

          $('<div />').append($.parseHTML(dDescriptn))
            .appendTo(divDiscusssaoInner);
          $('<hr>').appendTo(divDiscussaoInfo);
        }
      }
    });
  });
  </script>

	<script type= 'text/javascript'>
		// Adiciona os parceiros atuais do laboratório.
		$(document).ready(function(){
			var comunidadeAtual = Base.getUrlParameter("id");

			$.ajax({
				type: 'POST',
				url: 'ControleDados/UsuarioParceriaComunidade.php',
				dataType: 'json',
				data: 'func=getParceiroByIdComunidade&idComunidade='+comunidadeAtual,
				success: function (data) {

					conteudo = "";
					conteudo2 = "";

					for (i = 0; i < data.length; i++) {
						conteudo += "<option value='" + data[i]["username"] + "'>" + data[i]["nome"] + "</option>";
						conteudo2 += "<p>" + data[i]["username"] + "</p>";
					}

					document.getElementById("select-remove-parc").innerHTML = document.getElementById("select-remove-parc").innerHTML + conteudo;


					if (conteudo2 != "") {
						document.getElementById("lista-parceiros").innerHTML = conteudo2;
					} else {
						document.getElementById("lista-parceiros").innerHTML = "Não há parceiros."
					}
				}
            });
		});
	</script>

  </head>
  <body>
    <header><!-- logo do academiq --></header>

    <h2>Laboratório</h2>

	<div id="conteudo"></div>  
    <main>
      <h3>Discussões</h3>

	  <!-- Trigger/Open The Modal -->
      <button id="addDiscBtn">Adicionar</button>
      <!-- The Modal -->
      <div id="addDiscModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
          <span id="closeAddDisc" class="close">&times;</span>
          <form id= 'form-addDisc'>
      			<label for="titulo-add">Título</label><br>
      			<input id= 'titulo-add' type= 'text'>
				
				<br>
				<label for="descricao-add">Descrição</label><br>
      			<textarea rows="4" cols="50" id= 'descricao-add'></textarea>
				
				<br>
				<label for="publica-add">Pública</label><br>
				<select id="publica-add">
					<option value="1">Sim</option>
					<option value="0">Não</option>
				</select>
				<br><br>
      			<button id= 'btn-addDisc' type= 'button'>Adicionar</button>
      		</form>
        </div>
      </div>
	  
	  
	  <div id="discussoes"></div>
      <br><br>
      <h3>Parceiros</h3>
	  <div id="lista-parceiros"></div>

      <!-- Trigger/Open The Modal -->
      <button id="addParcBtn">Adicionar Parceiro</button>
      <!-- The Modal -->
      <div id="addParcModal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
          <span id="closeAdd" class="close">&times;</span>
          <form id= 'form-addParc'>
      			<p>Nome do Convidado</p>
      			<input id= 'username' type= 'text'>
      			<button id= 'btn-addParc' type= 'button'>Enviar</button>
      		</form>
        </div>
      </div>
      <hr>


    <button id= 'btn-remover-modal'>Remover Parceiro</button>
    <!-- The Modal -->
    <div id="delParcModal" class="modal">
      <!-- Modal content -->
      <div class="modal-content">
        <span id="closeRemove" class="close">&times;</span>
        <select id= 'select-remove-parc'>
    			<p>Selecione um Parceiro que deseja remover</p>
    	</select>
        <button id= 'btn-remover' type= 'button'>Confirmar</button>
      </div>
    </main>

	<script>
        // Get the modal
        var modal0 = document.getElementById("addDiscModal");

        // Get the button that opens the modal
        var btn0 = document.getElementById("addDiscBtn");

        // Get the <span> element that closes the modal
        var span0 = document.getElementById("closeAddDisc");

        // When the user clicks the button, open the modal
        btn0.onclick = function() {
          modal0.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span0.onclick = function() {
          modal0.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
          if (event.target == modal0) {
            modal0.style.display = "none";
          }
        }
    </script>
	
	
    <script>
        // Get the modal
        var modal1 = document.getElementById("addParcModal");

        // Get the button that opens the modal
        var btn1 = document.getElementById("addParcBtn");

        // Get the <span> element that closes the modal
        var span1 = document.getElementById("closeAdd");

        // When the user clicks the button, open the modal
        btn1.onclick = function() {
          modal1.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span1.onclick = function() {
          modal1.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
          if (event.target == modal1) {
            modal1.style.display = "none";
          }
        }
    </script>

    <script>
        // Get the modal
        var modal2 = document.getElementById("delParcModal");

        // Get the button that opens the modal
        var btn2 = document.getElementById("btn-remover-modal");

        // Get the <span> element that closes the modal
        var span2 = document.getElementById("closeRemove");

        // When the user clicks the button, open the modal
        btn2.onclick = function() {
          modal2.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span2.onclick = function() {
          modal2.style.display = "none";
        }
	
        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
          if (event.target == modal2) {
            modal2.style.display = "none";
          }
        }
	</script>
  </body>
</html>
