<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script src="https://momentjs.com/downloads/moment-with-locales.js"></script>
		<script src="https://cdn.ckeditor.com/ckeditor5/10.0.1/classic/ckeditor.js"></script>
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
		
		<!-- Modal jQuery -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.js"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-modal/0.9.1/jquery.modal.min.css" />
		
		<link rel="stylesheet" type="text/css" href="Assets/CSS/laboratorio.css">

		<script src="AcessoDados/Base.js"></script>
		<!-- Carregar apenas se necessário na página: -->
		<script src="AcessoDados/Discussao.js"></script>
		<script src="AcessoDados/Comunidade.js"></script>
		<script src="AcessoDados/Usuario.js"></script>

	
		<script>
		
			function definirFixoDiscussao(id) {
				var fixoId = "fixDiscBtn" + id;
				var valorAtual = document.getElementById(fixoId).value;
				var novoValor = "1";
				if (valorAtual == "1") {
					novoValor = "0";
				}
				
				Discussao.mudarFixo(id, novoValor, function(result) {
					if (result.erro == true) {
						alert(result.mensagem);
					}else{
						alert('Discussao alterada.');
						location.reload();
					}
				});			
			}
			
			
			function editarDiscussaoModal(id) {
				// Modal para edição dos dados num form.
				var modal = document.getElementById('novaMensagemModal');
				
				if (id != 0) {
					Discussao.getById(id, function(disc) {
						var disc = JSON.parse(disc);
						document.getElementById('titulo-add').value = disc.titulo;
						Discussao.editorDiscussao.setData(disc.descricao);
						document.getElementById('publica-add').value = disc.publica;
					
						document.getElementById("btn-addDisc").onclick = function() {
							Discussao.editar(id, 
								document.getElementById('titulo-add').value, 
								Discussao.editorDiscussao.getData(), 
								document.getElementById('publica-add').value, 
								function(data) {
									if (data.erro == false) {
										alert('Discussão alterada com sucesso.');
										location.reload();
									}
								}
							)
						};
					});
				
				} else {
					document.getElementById('titulo-add').value = "";
					Discussao.editorDiscussao.setData("");
					document.getElementById('publica-add').value = "1";
				
					document.getElementById("btn-addDisc").onclick = function() {
						Discussao.adicionar(Base.getUrlParameter("id"), 
							document.getElementById('titulo-add').value, 
							Discussao.editorDiscussao.getData(), 
							document.getElementById('publica-add').value, 
							localStorage.userId,
							function(data) {
								if (data.erro == false) {
									alert('Discussão adicionada com sucesso.');
									location.reload();
								}
							}
						)
					};
				}
			}
			
			
			function editDadosLab(toggle, elementId, iconId) { 
				if (toggle == 0) {
					document.getElementById(elementId).contentEditable = "true"; 
					document.getElementById(iconId).className = 'far fa-save';
					document.getElementById(elementId).style.backgroundColor = "#cccccc";
					document.getElementById(iconId).onclick = function() { editDadosLab(1, elementId, iconId) };
				} else {
					document.getElementById(elementId).contentEditable = "false"; 
					document.getElementById(iconId).className = 'far fa-edit';
					document.getElementById(elementId).style.backgroundColor = "#ffffff";
					document.getElementById(iconId).onclick = function() { editDadosLab(0, elementId, iconId) };
					
					// Salva os dados no BD:
					Comunidade.editar(
						Base.getUrlParameter("id"), 
						document.getElementById("nomeLab").innerHTML, 
						document.getElementById("descricaoLab").innerHTML, 
						document.getElementById("temaLab").innerHTML, 
						document.getElementById("adminLab").innerHTML
					);
				}
			}
		
		
			function loadDiscussoes(discussoes, idUsuarioAdministrador) {
			
				for (var iterador = 0; iterador < discussoes.length; iterador++) {
					var contentD = "";
					var imagemCriador = discussoes[iterador].urlImagemPerfil;
					if (imagemCriador == "") {
						imagemCriador = "Assets/Imagens/avatar round.png";
					} 
				
					contentD += '<div class="discussao-lab">';
					contentD += '<div class="topo-discussao">';
					contentD += '<img src="' + imagemCriador + '" title="Imagem de perfil" alt="Imagem de perfil">';
					contentD += '<h2>' + discussoes[iterador].titulo + '</h2>';
					contentD += '<p>Criada por ' + discussoes[iterador].username + '</p>';
					
					if (localStorage.userId == discussoes[iterador].idUsuarioCriador) {
						contentD += "<button class='editDiscBtn' onclick='editarDiscussaoModal(" + discussoes[iterador].id +")'><a href='#editarDiscussaoModal' rel='modal:open'>Editar</a></button>";
					}
					
					if (localStorage.userId == discussoes[iterador].idUsuarioCriador || 
						localStorage.userId == idUsuarioAdministrador) {
						contentD += "<button class='removeDiscBtn' onclick='Discussao.remover(" + discussoes[iterador].id + ", function(data) { location.reload(); });'>Remover</button>";
					}
					
					var fixoId = "fixDiscBtn" + discussoes[iterador].id;
					if (localStorage.userId == idUsuarioAdministrador) {
						contentD += "<button id='" + fixoId + "' class='fixDiscBtn' onclick='definirFixoDiscussao(" + discussoes[iterador].id + ");' value='" + discussoes[iterador].fixa + "'></button>";
						
					}
					
					contentD += '</div><p class="clear"></p>';
					contentD += '<div id="conteudo-discussao-' + discussoes[iterador].id + '"></div>';
					contentD += '</div><p class="clear"></p>';

					document.getElementById("discussoes").innerHTML += contentD;
					$('#conteudo-discussao-' + discussoes[iterador].id).append($.parseHTML(discussoes[iterador].descricao));
					
					
					if (discussoes[iterador].fixa == "1" && document.getElementById(fixoId) != undefined) {
						document.getElementById(fixoId).innerHTML = "Desafixar";
					} else if (discussoes[iterador].fixa == "0" && document.getElementById(fixoId) != undefined){
						document.getElementById(fixoId).innerHTML = "Fixar";
					}
			
				}
			
			
			}
		
		
		
			// Preenche os dados do laboratório.
			$(document).ready(function(){
				Comunidade.getById(Base.getUrlParameter("id"), function(data) {
					data = JSON.parse(data);
					Usuario.getById(data.idUsuarioAdministrador, function(dataUs) {
						var usuarioAdmin = JSON.parse(dataUs);
						
						document.getElementById("nomeLab").innerHTML = data.nome;
					
						var dadosLab = "";
						dadosLab += "Tema: <p id='temaLab'>" + data.tema + "</p><br>";
						dadosLab += "Descrição: <p id='descricaoLab'>" + data.descricao + "</p><br>";
						dadosLab += "Admin: <p id='adminLab'>" + usuarioAdmin.username + "</p><br>";
						
						document.getElementById("dadosLab").innerHTML = dadosLab;	
						
						// Edição de dados do laboratório.
						if (localStorage.userId == data.idUsuarioAdministrador) {

							$( "<i id='editNomeIcon' class='far fa-edit' onclick='editDadosLab(0,\"nomeLab\", \"editNomeIcon\");'></i>" ).insertAfter( "#nomeLab" );
							
							$( "<i id='editTemaIcon' class='far fa-edit' onclick='editDadosLab(0,\"temaLab\", \"editTemaIcon\");'></i>" ).insertAfter( "#temaLab" );
							
							$( "<i id='editDescricaoIcon' class='far fa-edit' onclick='editDadosLab(0,\"descricaoLab\", \"editDescricaoIcon\");'></i>" ).insertAfter( "#descricaoLab" );

							$('#detalhesLab').append("<a href='detalhesLab.html?id=" + Base.getUrlParameter("id") + "' title='Parceiros e Solicitações'>Parceiros e Solicitações</a>")
							
							
						}
							
					});

				
				
					// Carrega as discussões do laboratório.
					Discussao.getDiscussaoDoLab(Base.getUrlParameter("id"), function(discussoes) {
						loadDiscussoes(discussoes, data.idUsuarioAdministrador);	
						
					});
				});
				
				
				ClassicEditor
					.create( document.querySelector( '#descricao-add' ) )
					.then( editor => {
						Discussao.editorDiscussao = editor;
					} )
					.catch( error => {
						console.error( error );
					} );
					
					
				// Pesquisa.
				$('#btn-search').click(function(){
					var searchTxt=$('#search-discussoes').val();
					var searchType=$('input[name=typeSearch]:checked').val();
					if (searchTxt!= '') {
						if (searchType == "titulo") {
							Discussao.getByTitulo(searchTxt, Base.getUrlParameter("id"), function(discussoes) {
								if (discussoes.length == 0) {
									alert("Não foram encontradas discussões.");
								} else {
									document.getElementById("discussoes").innerHTML = "";
									Comunidade.getById(Base.getUrlParameter("id"), function(dataCom) {
										loadDiscussoes(discussoes, dataCom.idUsuarioAdministrador);	
									});
								}
							});
						
						} else {
							Discussao.getByDescricao(searchTxt, Base.getUrlParameter("id"), function(discussoes) {
								if (discussoes.length == 0) {
									alert("Não foram encontradas discussões.");
								} else {
									document.getElementById("discussoes").innerHTML = "";
									Comunidade.getById(Base.getUrlParameter("id"), function(dataCom) {
										loadDiscussoes(discussoes, dataCom.idUsuarioAdministrador);	
									});
								}
							
							});
						}
					}
				});
			
			
			});
		
		</script>
	
	
	
	</head>
	<body>
		<!-- Barra de navegação com botão pro perfil -->
		<nav></nav>
	
		<!-- Nome do laboratório -->
		<h1 id="nomeLab"></h1>
		<p class='clear'></p>

		<!-- Tema, descrição, username do admin, edição dos dados... -->	
		<div id="dadosLab"></div>
		<p class='clear'></p>
	
	
		<!-- Links para parceiros e solicitações -->
		<p id="detalhesLab"></p>
		<p class='clear'></p>
		
	
		<!-- Pesquisa de discussões -->
		<div>
			<input type='text' id='search-discussoes'></input>
			<input type="radio" name="typeSearch" value="titulo" checked>Por título
			<input type="radio" name="typeSearch" value="conteudo">Por conteúdo<br>
			<button type='button' id='btn-search'>Pesquisar discussões</button>
		</div>
		<p class='clear'></p>
		
		
		<!-- Discussões -->
		<div id="discussoes"></div>
		<p class='clear'></p>
		
		<!--Adicionar discussão -->
		<button class='editDiscBtn' onclick='editarDiscussaoModal(0)'><a href='#editarDiscussaoModal' rel='modal:open'>Adicionar discussão</a></button>
	
		<div id="editarDiscussaoModal" class="modal">
			<form id='form-addDisc'>
      			<label for="titulo-add">Título</label><br>
      			<input id='titulo-add' type='text'>
				
				<p class='clear'></p>
				<label for="descricao-add">Descrição</label><br>
      			<textarea id= 'descricao-add'></textarea>
				
				<p class='clear'></p>
				<label for="publica-add">Pública</label><br>
				<select id="publica-add">
					<option value="1">Sim</option>
					<option value="0">Não</option>
				</select>
				<p class='clear'></p>
      			<button id= 'btn-addDisc' type= 'button'>Salvar</button>
      		</form>
		</div>
	
	</body>
</html>
